name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã¨ãƒªãƒªãƒ¼ã‚¹

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  version-and-release:
    runs-on: ubuntu-latest
    name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³è‡ªå‹•æ›´æ–°ã¨ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã‚³ãƒŸãƒƒãƒˆã«ã‚ˆã‚‹ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é˜²ã
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Gitãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        id: get_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $CURRENT_VERSION"
      
      - name: å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—å‰ï¼‰
        id: get_previous_tag
        run: |
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -1 2>/dev/null || echo "")
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "å‰å›ã®ã‚¿ã‚°: ãªã—ï¼ˆæœ€åˆã®ãƒªãƒªãƒ¼ã‚¹ï¼‰"
          else
            echo "å‰å›ã®ã‚¿ã‚°: $PREVIOUS_TAG"
          fi
      
      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
        id: bump_version
        run: |
          npm version patch -m "chore: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ %s ã«æ›´æ–° [skip ci]"
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $NEW_VERSION"
      
      - name: å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          git push origin main --follow-tags
      
      - name: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        id: release_notes
        run: |
          PREVIOUS_TAG="${{ steps.get_previous_tag.outputs.previous_tag }}"
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "æœ€åˆã®ãƒªãƒªãƒ¼ã‚¹ã§ã™"
            NOTES="## ğŸ‰ æœ€åˆã®ãƒªãƒªãƒ¼ã‚¹\n\n"
            NOTES+="### å¤‰æ›´å†…å®¹\n"
            NOTES+="$(git log --pretty=format:'- %s (%h)' --no-merges | head -10)"
          else
            echo "å‰å›ã®ã‚¿ã‚°: $PREVIOUS_TAG"
            NOTES="## ğŸ“ å¤‰æ›´å†…å®¹\n\n"
            NOTES+="### ã‚³ãƒŸãƒƒãƒˆå±¥æ­´\n"
            NOTES+="$(git log $PREVIOUS_TAG..HEAD --pretty=format:'- %s (%h)' --no-merges | grep -v 'chore: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’')"
          fi
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.bump_version.outputs.new_version }}
          name: Release v${{ steps.bump_version.outputs.new_version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
      
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼
        run: |
          echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ steps.get_version.outputs.current_version }} â†’ ${{ steps.bump_version.outputs.new_version }}"
          echo "âœ… ãƒªãƒªãƒ¼ã‚¹ v${{ steps.bump_version.outputs.new_version }} ã‚’ä½œæˆã—ã¾ã—ãŸ"
          echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã‚’é¸æŠã—ã¦ãã ã•ã„"
