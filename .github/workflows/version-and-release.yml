name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã¨ãƒªãƒªãƒ¼ã‚¹

on:
  pull_request:
    branches:
      - main
    types: [closed]

permissions:
  contents: write

jobs:
  version-and-release:
    runs-on: ubuntu-latest
    name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³è‡ªå‹•æ›´æ–°ã¨ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    # PRãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.pull_request.merged == true

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Gitãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        id: get_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $CURRENT_VERSION"

      - name: å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—å‰ï¼‰
        id: get_previous_tag
        run: |
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -1 2>/dev/null || echo "")
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "å‰å›ã®ã‚¿ã‚°: ãªã—ï¼ˆæœ€åˆã®ãƒªãƒªãƒ¼ã‚¹ï¼‰"
          else
            echo "å‰å›ã®ã‚¿ã‚°: $PREVIOUS_TAG"
          fi

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
        id: bump_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          # æ¬¡ã®ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨ˆç®—
          NEXT_VERSION=$(node -p "
            const v = '$CURRENT_VERSION'.split('.');
            v[2] = parseInt(v[2]) + 1;
            v.join('.');
          ")
          TAG_NAME="v$NEXT_VERSION"
          echo "æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³äºˆå®š: $TAG_NAME"

          # ã‚¿ã‚°ãŒã™ã§ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ—¢å­˜ã‚¿ã‚°ã‚’ä½¿ç”¨
          if git tag --list | grep -q "^$TAG_NAME$"; then
            echo "ã‚¿ã‚° $TAG_NAME ã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚package.jsonã®ã¿æ›´æ–°ã—ã¾ã™ã€‚"
            node -e "
              const fs = require('fs');
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              pkg.version = '$NEXT_VERSION';
              fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            "
            git add package.json
            git commit -m "chore: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ $NEXT_VERSION ã«æ›´æ–° [skip ci]"
          else
            npm version patch -m "chore: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ %s ã«æ›´æ–° [skip ci]"
          fi

          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $NEW_VERSION"

      - name: å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          git push origin HEAD:main --follow-tags

      - name: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        id: release_notes
        run: |
          PREVIOUS_TAG="${{ steps.get_previous_tag.outputs.previous_tag }}"
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          REPO="${{ github.repository }}"

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "æœ€åˆã®ãƒªãƒªãƒ¼ã‚¹ã§ã™"
            COMMITS=$(git log --pretty=format:'- %s (%h)' --no-merges | head -10)
            NOTES="## ğŸ‰ æœ€åˆã®ãƒªãƒªãƒ¼ã‚¹

### å¤‰æ›´å†…å®¹
$COMMITS"
          else
            echo "å‰å›ã®ã‚¿ã‚°: $PREVIOUS_TAG"
            COMMITS=$(git log "$PREVIOUS_TAG"..HEAD --pretty=format:'- %s (%h)' --no-merges | grep -v 'chore: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’' || true)
            COMPARE_URL="https://github.com/$REPO/compare/$PREVIOUS_TAG...v$NEW_VERSION"
            if [ -z "$COMMITS" ]; then
              COMMITS="- ãƒã‚¤ãƒŠãƒ¼ãªæ”¹å–„ã¨ä¿®æ­£"
            fi
            NOTES="## ğŸ“ å¤‰æ›´å†…å®¹

$COMMITS

---
ğŸ” **ã™ã¹ã¦ã®å¤‰æ›´ã‚’ç¢ºèª**: $COMPARE_URL"
          fi

          {
            echo "notes<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.bump_version.outputs.new_version }}
          name: Release v${{ steps.bump_version.outputs.new_version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false

      - name: ãƒªãƒªãƒ¼ã‚¹å®Œäº†ã‚µãƒãƒªãƒ¼
        run: |
          echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ steps.get_version.outputs.current_version }} â†’ ${{ steps.bump_version.outputs.new_version }}"
          echo "âœ… ãƒªãƒªãƒ¼ã‚¹ v${{ steps.bump_version.outputs.new_version }} ã‚’ä½œæˆã—ã¾ã—ãŸ"
          echo "ğŸ”— https://github.com/${{ github.repository }}/releases/tag/v${{ steps.bump_version.outputs.new_version }}"
