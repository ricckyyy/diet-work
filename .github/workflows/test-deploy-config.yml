name: ğŸ§ª ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šç”Ÿæˆã®ãƒ†ã‚¹ãƒˆ

on:
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'ãƒ†ã‚¹ãƒˆã™ã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚’é¸æŠ'
        required: true
        type: choice
        options:
          - 'vercel'
          - 'netlify'
          - 'cloudflare-pages'
          - 'railway'
          - 'render'
      create_files:
        description: 'å®Ÿéš›ã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ï¼ˆãƒ†ã‚¹ãƒˆãƒ–ãƒ©ãƒ³ãƒã«ï¼‰'
        required: true
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  test-deploy-config:
    runs-on: ubuntu-latest
    name: ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šç”Ÿæˆã®ãƒ†ã‚¹ãƒˆ
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Gitãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: ãƒ†ã‚¹ãƒˆç”¨ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        run: |
          mkdir -p /tmp/deploy-test
          echo "ğŸ“ ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸ"
      
      - name: Vercelè¨­å®šã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        if: github.event.inputs.deploy_target == 'vercel'
        run: |
          echo "## ğŸš€ Vercel ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"
          echo ""
          echo "### vercel.json"
          echo '```json'
          cat << 'EOF'
          {
            "buildCommand": "npm run build",
            "devCommand": "npm run dev",
            "installCommand": "npm install",
            "framework": "nextjs",
            "outputDirectory": ".next"
          }
          EOF
          echo '```'
          echo ""
          echo "### .vercelignore"
          echo '```'
          cat << 'EOF'
          node_modules
          .next
          .env*
          prisma/dev.db
          EOF
          echo '```'
          
          if [ "${{ github.event.inputs.create_files }}" = "true" ]; then
            cat > vercel.json << 'VERCEL_EOF'
          {
            "buildCommand": "npm run build",
            "devCommand": "npm run dev",
            "installCommand": "npm install",
            "framework": "nextjs",
            "outputDirectory": ".next"
          }
          VERCEL_EOF
            
            cat > .vercelignore << 'VERCEL_EOF'
          node_modules
          .next
          .env*
          prisma/dev.db
          VERCEL_EOF
            echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi
      
      - name: Netlifyè¨­å®šã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        if: github.event.inputs.deploy_target == 'netlify'
        run: |
          echo "## ğŸš€ Netlify ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"
          echo ""
          echo "### netlify.toml"
          echo '```toml'
          cat << 'EOF'
          [build]
            command = "npm run build"
          
          [build.environment]
            NODE_VERSION = "20"
          
          [[plugins]]
            package = "@netlify/plugin-nextjs"
          EOF
          echo '```'
          
          if [ "${{ github.event.inputs.create_files }}" = "true" ]; then
            cat > netlify.toml << 'NETLIFY_EOF'
          [build]
            command = "npm run build"
          
          [build.environment]
            NODE_VERSION = "20"
          
          [[plugins]]
            package = "@netlify/plugin-nextjs"
          NETLIFY_EOF
            echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi
      
      - name: Cloudflare Pagesè¨­å®šã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        if: github.event.inputs.deploy_target == 'cloudflare-pages'
        run: |
          APP_NAME="${GITHUB_REPOSITORY#*/}"
          COMPAT_DATE=$(date +%Y-%m-%d)
          
          echo "## ğŸš€ Cloudflare Pages ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"
          echo ""
          echo "### wrangler.toml"
          echo '```toml'
          cat << EOF
          name = "$APP_NAME"
          compatibility_date = "$COMPAT_DATE"
          
          [build]
            command = "npm run build"
          EOF
          echo '```'
          
          echo ""
          echo "### CLOUDFLARE_DEPLOY_NOTE.md"
          echo '```markdown'
          cat << 'EOF'
          # Cloudflare Pagesãƒ‡ãƒ—ãƒ­ã‚¤ã«é–¢ã™ã‚‹æ³¨æ„äº‹é …
          
          Cloudflare Pagesã¯ã€Next.jsã®ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€
          è¨­å®šã«ã¯ä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼š
          
          1. ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰: `npm run build`
          2. å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: è‡ªå‹•æ¤œå‡ºã•ã‚Œã¾ã™ï¼ˆ`.next`ï¼‰
          3. Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³: 20ã‚’é¸æŠ
          
          ## ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
          Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š
          - `DATABASE_URL`: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—
          
          ## å‚è€ƒæƒ…å ±
          - https://developers.cloudflare.com/pages/framework-guides/nextjs/
          EOF
          echo '```'
          
          if [ "${{ github.event.inputs.create_files }}" = "true" ]; then
            cat > wrangler.toml << EOF
          name = "$APP_NAME"
          compatibility_date = "$COMPAT_DATE"
          
          [build]
            command = "npm run build"
          EOF
            
            cat > CLOUDFLARE_DEPLOY_NOTE.md << 'CF_EOF'
          # Cloudflare Pagesãƒ‡ãƒ—ãƒ­ã‚¤ã«é–¢ã™ã‚‹æ³¨æ„äº‹é …
          
          Cloudflare Pagesã¯ã€Next.jsã®ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€
          è¨­å®šã«ã¯ä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼š
          
          1. ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰: `npm run build`
          2. å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: è‡ªå‹•æ¤œå‡ºã•ã‚Œã¾ã™ï¼ˆ`.next`ï¼‰
          3. Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³: 20ã‚’é¸æŠ
          
          ## ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
          Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š
          - `DATABASE_URL`: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—
          
          ## å‚è€ƒæƒ…å ±
          - https://developers.cloudflare.com/pages/framework-guides/nextjs/
          CF_EOF
            echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi
      
      - name: Railwayè¨­å®šã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        if: github.event.inputs.deploy_target == 'railway'
        run: |
          echo "## ğŸš€ Railway ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"
          echo ""
          echo "### railway.json"
          echo '```json'
          cat << 'EOF'
          {
            "$schema": "https://railway.app/railway.schema.json",
            "build": {
              "builder": "NIXPACKS",
              "buildCommand": "npm run build"
            },
            "deploy": {
              "startCommand": "npm run start",
              "restartPolicyType": "ON_FAILURE",
              "restartPolicyMaxRetries": 10
            }
          }
          EOF
          echo '```'
          echo ""
          echo "### nixpacks.toml"
          echo '```toml'
          cat << 'EOF'
          [phases.setup]
            nixPkgs = ["nodejs-20_x", "npm-10_x"]
          
          [phases.install]
            cmds = ["npm ci"]
          
          [phases.build]
            cmds = ["npm run build", "npx prisma generate"]
          
          [start]
            cmd = "npm run start"
          EOF
          echo '```'
          
          if [ "${{ github.event.inputs.create_files }}" = "true" ]; then
            cat > railway.json << 'RAILWAY_EOF'
          {
            "$schema": "https://railway.app/railway.schema.json",
            "build": {
              "builder": "NIXPACKS",
              "buildCommand": "npm run build"
            },
            "deploy": {
              "startCommand": "npm run start",
              "restartPolicyType": "ON_FAILURE",
              "restartPolicyMaxRetries": 10
            }
          }
          RAILWAY_EOF
            
            cat > nixpacks.toml << 'RAILWAY_EOF'
          [phases.setup]
            nixPkgs = ["nodejs-20_x", "npm-10_x"]
          
          [phases.install]
            cmds = ["npm ci"]
          
          [phases.build]
            cmds = ["npm run build", "npx prisma generate"]
          
          [start]
            cmd = "npm run start"
          RAILWAY_EOF
            echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi
      
      - name: Renderè¨­å®šã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        if: github.event.inputs.deploy_target == 'render'
        run: |
          APP_NAME="${GITHUB_REPOSITORY#*/}"
          
          # Prismaã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ç¢ºèª
          if [ -f "prisma/schema.prisma" ]; then
            BUILD_CMD="npm install && npm run build && npx prisma generate"
            PRISMA_STATUS="âœ… PrismaãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          else
            BUILD_CMD="npm install && npm run build"
            PRISMA_STATUS="â„¹ï¸ Prismaã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi
          
          echo "## ğŸš€ Render ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"
          echo ""
          echo "$PRISMA_STATUS"
          echo ""
          echo "### render.yaml"
          echo '```yaml'
          cat << EOF
          services:
            - type: web
              name: $APP_NAME
              env: node
              plan: free
              buildCommand: $BUILD_CMD
              startCommand: npm run start
              envVars:
                - key: NODE_VERSION
                  value: 20
                - key: DATABASE_URL
                  sync: false
          EOF
          echo '```'
          
          if [ "${{ github.event.inputs.create_files }}" = "true" ]; then
            cat > render.yaml << EOF
          services:
            - type: web
              name: $APP_NAME
              env: node
              plan: free
              buildCommand: $BUILD_CMD
              startCommand: npm run start
              envVars:
                - key: NODE_VERSION
                  value: 20
                - key: DATABASE_URL
                  sync: false
          EOF
            echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi
      
      - name: ãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼
        run: |
          echo "## ğŸ¯ ãƒ†ã‚¹ãƒˆçµæœ"
          echo ""
          echo "âœ… é¸æŠã•ã‚ŒãŸãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ: **${{ github.event.inputs.deploy_target }}**"
          echo "âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: æˆåŠŸ"
          echo ""
          if [ "${{ github.event.inputs.create_files }}" = "true" ]; then
            echo "âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ: å®Œäº†"
            echo ""
            echo "ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
            git status --short
          else
            echo "â„¹ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿ï¼‰"
          fi
          echo ""
          echo "### ğŸ“‹ å®Ÿéš›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†"
          echo "1. ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ"
          echo "2. README.mdã«ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã‚’è¿½åŠ "
          echo "3. æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒŸãƒƒãƒˆ"
          echo "4. ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥"
          echo "5. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•ä½œæˆ"
      
      - name: ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if: github.event.inputs.create_files == 'true'
        run: |
          echo "## ğŸ“„ ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹"
          echo ""
          for file in vercel.json .vercelignore netlify.toml wrangler.toml CLOUDFLARE_DEPLOY_NOTE.md railway.json nixpacks.toml render.yaml; do
            if [ -f "$file" ]; then
              echo "### $file"
              echo '```'
              cat "$file"
              echo '```'
              echo ""
            fi
          done
