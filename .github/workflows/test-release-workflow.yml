name: リリースワークフローのテスト

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'テストモード（trueにすると実際のリリースは作成しません）'
        required: true
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  test-version-and-release:
    runs-on: ubuntu-latest
    name: バージョンアップとリリースのテスト

    steps:
      - name: リポジトリのチェックアウト
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Node.jsのセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Gitユーザー設定
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 現在のバージョンを取得
        id: get_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "現在のバージョン: $CURRENT_VERSION"

      - name: 前回のタグを取得
        id: get_previous_tag
        run: |
          git fetch --tags
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -1 2>/dev/null || echo "")
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "前回のタグ: なし（最初のリリース）"
          else
            echo "前回のタグ: $PREVIOUS_TAG"
          fi

      - name: バージョンをインクリメント
        id: bump_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          NEXT_VERSION=$(node -p "
            const v = '$CURRENT_VERSION'.split('.');
            v[2] = parseInt(v[2]) + 1;
            v.join('.');
          ")
          TAG_NAME="v$NEXT_VERSION"
          echo "次のバージョン: $TAG_NAME"

          if [ "${{ inputs.test_mode }}" = "true" ]; then
            echo "テストモード: バージョン更新・タグ作成をスキップ"
            echo "new_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          elif git tag --list | grep -q "^$TAG_NAME$"; then
            echo "タグ $TAG_NAME はすでに存在します。package.jsonのみ更新します。"
            node -e "
              const fs = require('fs');
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              pkg.version = '$NEXT_VERSION';
              fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            "
            git add package.json
            git commit -m "chore: バージョンを $NEXT_VERSION に更新 [skip ci]"
            NEW_VERSION=$(node -p "require('./package.json').version")
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          else
            npm version patch -m "chore: バージョンを %s に更新 [skip ci]"
            NEW_VERSION=$(node -p "require('./package.json').version")
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: 変更をプッシュ
        if: inputs.test_mode != true
        run: |
          git push origin HEAD:main --follow-tags

      - name: リリースノートを生成
        id: release_notes
        run: |
          PREVIOUS_TAG="${{ steps.get_previous_tag.outputs.previous_tag }}"
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          REPO="${{ github.repository }}"

          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:'- %s (%h)' --no-merges | head -10)
            NOTES=$(printf '## 最初のリリース\n\n### 変更内容\n%s' "$COMMITS")
          else
            COMMITS=$(git log "$PREVIOUS_TAG"..HEAD --pretty=format:'- %s (%h)' --no-merges | grep -v 'chore: バージョンを' || true)
            COMPARE_URL="https://github.com/$REPO/compare/$PREVIOUS_TAG...v$NEW_VERSION"
            if [ -z "$COMMITS" ]; then
              COMMITS="- マイナーな改善と修正"
            fi
            NOTES=$(printf '## 変更内容\n\n%s\n\n---\nすべての変更を確認: %s' "$COMMITS" "$COMPARE_URL")
          fi

          {
            echo "notes<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "リリースノートプレビュー:"
          echo "$NOTES"

      - name: GitHubリリースを作成
        if: inputs.test_mode != true
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: 'v${{ steps.bump_version.outputs.new_version }}',
              name: 'Release v${{ steps.bump_version.outputs.new_version }}',
              body: `${{ steps.release_notes.outputs.notes }}`,
              draft: false,
              prerelease: false,
            });

      - name: サマリー
        run: |
          if [ "${{ inputs.test_mode }}" = "true" ]; then
            echo "テストモード完了"
            echo "バージョン ${{ steps.get_version.outputs.current_version }} → ${{ steps.bump_version.outputs.new_version }} になる予定"
          else
            echo "リリース完了"
            echo "バージョン ${{ steps.get_version.outputs.current_version }} → ${{ steps.bump_version.outputs.new_version }}"
            echo "https://github.com/${{ github.repository }}/releases/tag/v${{ steps.bump_version.outputs.new_version }}"
          fi
