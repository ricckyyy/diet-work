name: PRãƒªãƒªãƒ¼ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  release-preview:
    runs-on: ubuntu-latest
    name: ãƒãƒ¼ã‚¸å¾Œã®ãƒªãƒªãƒ¼ã‚¹å†…å®¹ã‚’ç¢ºèª

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        id: get_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨ˆç®—
        id: next_version
        run: |
          CURRENT_VERSION="${{ steps.get_version.outputs.current_version }}"
          NEXT_VERSION=$(node -p "
            const v = '$CURRENT_VERSION'.split('.');
            v[2] = parseInt(v[2]) + 1;
            v.join('.');
          ")
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT

      - name: å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
        id: get_previous_tag
        run: |
          git fetch --tags
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -1 2>/dev/null || echo "")
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - name: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
        id: release_notes
        run: |
          PREVIOUS_TAG="${{ steps.get_previous_tag.outputs.previous_tag }}"
          NEW_VERSION="${{ steps.next_version.outputs.next_version }}"
          REPO="${{ github.repository }}"

          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:'- %s (%h)' --no-merges | head -10)
            NOTES="## ğŸ‰ æœ€åˆã®ãƒªãƒªãƒ¼ã‚¹

### å¤‰æ›´å†…å®¹
$COMMITS"
          else
            COMMITS=$(git log "$PREVIOUS_TAG"..HEAD --pretty=format:'- %s (%h)' --no-merges | grep -v 'chore: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’' || true)
            COMPARE_URL="https://github.com/$REPO/compare/$PREVIOUS_TAG...v$NEW_VERSION"
            if [ -z "$COMMITS" ]; then
              COMMITS="- ãƒã‚¤ãƒŠãƒ¼ãªæ”¹å–„ã¨ä¿®æ­£"
            fi
            NOTES="## ğŸ“ å¤‰æ›´å†…å®¹

$COMMITS

---
ğŸ” **ã™ã¹ã¦ã®å¤‰æ›´ã‚’ç¢ºèª**: $COMPARE_URL"
          fi

          {
            echo "notes<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: PRã«ãƒªãƒªãƒ¼ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: release-preview
          message: |
            ## ğŸš€ ãƒªãƒªãƒ¼ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

            ã“ã®PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ä»¥ä¸‹ã®ãƒªãƒªãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

            | é …ç›® | å†…å®¹ |
            |------|------|
            | ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | `v${{ steps.get_version.outputs.current_version }}` |
            | æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | `v${{ steps.next_version.outputs.next_version }}` |
            | å‰å›ã®ã‚¿ã‚° | `${{ steps.get_previous_tag.outputs.previous_tag || 'ãªã—ï¼ˆæœ€åˆã®ãƒªãƒªãƒ¼ã‚¹ï¼‰' }}` |

            ### ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

            ${{ steps.release_notes.outputs.notes }}

            ---
            > ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯PRãŒæ›´æ–°ã•ã‚Œã‚‹ãŸã³ã«è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚
